---
title: "Best Practices"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
    code_folding: hide
vignette: >
  %\VignetteIndexEntry{Best Practices}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",fig.width=8, fig.height=4, dev='svg'
)
```

```{r setup, }
library(ggplot2)
library(ggcapdthemes)
extrafont::loadfonts(quiet=T)
```

```{css, echo=F}
.inline-figure {
  border: none !important;
}

```

## Introduction

```{r initial-plot, echo=FALSE}
## build ggplot barplot
p_bar <- ggplot(data = resource_mix[resource_mix$year == 2022,]) +
  geom_bar(mapping = aes(x = generation_resource_mix, y = resource_label, fill = resource_label),
           stat = 'identity') +
  labs(x = 'Generation Resource Mix (%)', y = 'Resource', fill = 'Resource', 
       title = '2022 eGRID Generation Resource Mix',
       caption = 'Data from 2022 eGRID summary data, Table 2') + 
  scale_fill_capd_discrete(palette = 'fuel_type') +
  scale_x_continuous(expand=c(0,0)) +
  theme_capd(orientation = 'vert') 
```

## Color as highlight

This theme includes both quantitative and categorical color palettes. However, there are some situations where you might
not want to use a whole palette; instead, you might want to use color to draw attention only to specific parts of a chart
without overwhelming the user. For more details on using color as a highlight, see the of the Data
Visualization Style Guide.

### Before 

### Applying the Code

Using the `gghighlight` package to assist, we can emphasize certain groups or elements of charts.

#### Highlighting discrete colors

Leave fuel type as original color, gray out non-highlighted groups.

```{r}
p_bar + gghighlight::gghighlight(
  resource == 'gas',
  unhighlighted_params = list(
    #fill = '#919191',
    fill = '#C9C9C9', 
    color = '#2E2E2E',
    linewidth = 0.2) 
)
  
```

#### Highlighting continuous colors

```{r, eval=F}

p_co2 <- ggplot(co2_emission_2022, aes(y = Region, x = co2)) + 
  geom_bar(stat = 'identity', fill = '#2378C3') + 
  theme_capd()

p_co2 +
  gghighlight::gghighlight(
    Region == 'NYUP',
    unhighlighted_params = list(
      fill = '#C9C9C9', 
      linewidth = 0.2
    ) 
  )

```

<a href="#TOC">Return to Table of Contents</a>

## Legends

Legends are most helpful and accessible when they are directly attached to the relevant data elements. If that isnâ€™t
possible, keeping them as close as possible to the data elements is a good compromise. For more details on legend design,
see the of the Data Visualization dedicated section Style Guide.

### Before 

By default, ggplot sorts character variables for color / fill alphabetically from A to Z. Sometimes this is desired, other times there are more useful orders for aligning to the data at hand.

```{r, echo = T}
ggplot(data = so2_aq,
       aes(x=year, y=value, color=stat)) +
  geom_line() +
  labs(color = 'Statistic') + 
  theme_capd()
```

### Applying the Code

#### Sorting legend

Using the `fct_reorder2` function from the `forcats` tidyverse package, you can easily reorder columns by another columns value. This allows the legend categories to go in order of highest to lowest value.

```{r}
ggplot(so2_aq,
       aes(x=year, y=value, color = forcats::fct_reorder2(stat, year, value))) +
  geom_line() +
  labs(color = 'Statistic') + 
  theme_capd()

```

#### Adding direct labels on your chart

Through the help of the `directlabels` package, you can also add labels directly onto a ggplot for easier context. Here we add them to the end of the lines using the `method = 'last.qp'` argument.

```{r}
p_direct <- ggplot(so2_aq, aes(x=year, y=value, color=stat)) +
              geom_line() +
              labs(color='Statistic', y = 'SO_2 Air Quality') + 
              theme_capd()

directlabels::direct.label(p_direct, method = 'last.qp')
directlabels::direct.label(p_direct, method = 'first.qp')

```

<a href="#TOC">Return to Table of Contents</a>

## Tooltips

Tooltips that call out names, values, and style (color, stroke pattern, etc.) of individual data elements can help make those
data points easier to identify in your chart. For more details on tooltip design, see the of the Data
Visualization Style Guide.

### Before 

### Applying the Code

```{r}
p_so2 <-ggplot(so2_aq,
       aes(x=year, y=value, color = stat)) +
  geom_line() +
  labs(color = 'Statistic') + 
  scale_color_capd_discrete(palette = 'sequential') +
  theme_capd()

plotly::ggplotly(p_so2)
```

### After

<a href="#TOC">Return to Table of Contents</a>

## Data labels

Like tooltips, data labels can help make individual or important data points easier to identify

<a href="#TOC">Return to Table of Contents</a>

## Alt text for charts 

Alternative text helps make charts more accessible for users who cannot rely on visuals. Alt text should be specific and
detailed but not overly wordy; it can be used in combination with other, non-visual representations of the same data, such as tables or direct downloads.

### Including Alt text manually

```{r, fig.alt='My alt text here'}
p_bar_alt <- p_bar + theme(legend.position='none') +labs(alt = 'My alt text here')

p_bar_alt
```

### Generating alt text template

```{r,}
ggalttext::generate_alt_text(p_bar)
```
<a href="#TOC">Return to Table of Contents</a>

## Other Data Accessibility

Another way to make your charts more accessible is to provide the underlying data directly to users either by providing data
tables near their respective charts, or by allowing users to download that data.


#### Color-Blindness

Variations of color accessibility can be assessed using the `colorblindr` package.

```{r, echo=1, eval=1,fig.width=10, fig.height=10}
colorblindr::cvd_grid(p_bar)
suppressWarnings(colorblindr::cvd_grid(p_bar+theme(legend.position='none')))
```


<a href="#TOC">Return to Table of Contents</a>

## Fuel Type icons

The eleven most commonly used fuel types in CAPD are represented by icons; you can include these icons where applicable
in your ggplot2 charts. For more details on integrating these icons (and how to use them appropriately), see the
of the Data Visualization Style Guide.

<a href="#TOC">Return to Table of Contents</a>

## Adding Logos and Images

Similarly to the fuel type icons, other logos and images can be incorporated into your ggplot2 charts.

<a href="#TOC">Return to Table of Contents</a>
